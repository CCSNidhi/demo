name: .NET

on:
  push: 
    branches:
      - main

jobs:
  build:
    runs-on: Windows-latest
    env:
         VERSION_FILE_NAME: 'VERSION'
         VERSION_BUMP_FILE: 'version_fragment'
   
         ACTIONS_ALLOW_UNSECURE_COMMANDS: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
 
      - name: Setup .NET
        uses: actions/setup-dotnet@v2
        with:
          dotnet-version: 7.0.x

      - name: Install MAUI workload  
        run: dotnet workload install maui
        working-directory: ./MauiApp_version/MauiApp_version
        
         
 
      
      - name: Check commit message and set version bump
        run: |
         commitMessage=$(git log -1 --pretty=format:%B)
         if [[ $commitMessage =~ patch ]]; then
          echo "bump=patch" >> $GITHUB_ENV
         elif [[ $commitMessage =~ minor ]]; then
          echo "bump=minor" >> $GITHUB_ENV
         elif [[ $commitMessage =~ major ]]; then
          echo "bump=major" >> $GITHUB_ENV
         else
           echo "bump=none" >> $GITHUB_ENV
      - name: Set current version in the VERSION file
        run: echo "1.0.0.1" > VERSION
      - name: Generate new version and update VERSION file
        run: |
         bump=$bump
         if [[ $bump == "patch" ]]; then
          newVersion=$(semver bump patch $(cat VERSION))
         elif [[ $bump == "minor" ]]; then
          newVersion=$(semver bump minor $(cat VERSION))
         elif [[ $bump == "major" ]]; then
          newVersion=$(semver bump major $(cat VERSION))
         else
          newVersion=$(cat VERSION)
         fi
         echo $newVersion > VERSION
         echo "newVersion=$newVersion" >> $GITHUB_ENV
      - name: Build the project
        run: dotnet build MauiApp_version/MauiApp_version/MauiApp_version.csproj --configuration Release
      - name: Publish the project
        run: dotnet publish MauiApp_version/MauiApp_version/MauiApp_version.csproj -c Release -f net7.0-windows10.0.19041.0 /p:GenerateAppxPackageOnBuild=true
      - name: Build again (if needed)
        run: dotnet build MauiApp_version/MauiApp_version/MauiApp_version.csproj --configuration Release









        




